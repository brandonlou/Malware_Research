import csv
import pickle
import sys
from numpy import mean, std
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score
from sklearn.model_selection import cross_val_score, KFold, train_test_split


NUM_FOLDS = 10
NUM_ESTIMATORS = 100


def main():
    if len(sys.argv) not in (2, 3):
        print('USAGE: python %s <input data file> [model export file]' % sys.argv[0])

    X_data = list()
    y_data = list()

    with open(sys.argv[1], 'rt') as csv_file:
        csv_reader = csv.reader(csv_file, delimiter=',')
        for row in csv_reader:
            X_data.append(list(map(float, row[:-1]))) # All but the last element.
            y_data.append(int(row[-1])) # The last element.

    # Prepare cross-validation procedure.
    cv = KFold(n_splits=NUM_FOLDS, shuffle=True)

    # Create model.
    rfc = RandomForestClassifier(n_estimators=NUM_ESTIMATORS)

    # Evaluate model.
    scores = cross_val_score(rfc, X_data, y_data, scoring='accuracy', cv=cv, n_jobs=-1)

    # Report performance.
    print(scores)
    print('Mean Accuracy: %.3f' % mean(scores))
    print('Standard Deviation: %.3f' % std(scores))

    # Export model.
    rfc.fit(X_data, y_data)
    if len(sys.argv) == 3:
        pickle.dump(rfc, open(sys.argv[2], 'wb'))
        print('Saved model to %s.' % sys.argv[2])

if __name__ == "__main__":
    main()
