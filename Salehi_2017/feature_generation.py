import csv
import os
import sys

if len(sys.argv) != 3:
    print('USAGE: %s [input directory] [output file]' % sys.argv[0])
    exit()

input_dir = sys.argv[1]
output_file = sys.argv[2]

# List of features with duplicates.
dup_features = list()

for filename in os.listdir(input_dir):
    with open(input_dir + '/' + filename) as infile:
        try:
            lines = infile.readlines()
        except:
            print('Error: Cannot read', filename)
            continue
    
    # Skip first line because it tells the verdict and isn't an API call.
    for i in range(1, len(lines)):
        lines[i] = lines[i].strip()
        dup_features.append(lines[i])

# Remove all duplicated features and store in a list (which is ordered).
features = list(dict.fromkeys(dup_features))

for filename in os.listdir(input_dir):
    with open(input_dir + '/' + filename) as infile:
        try:
            lines = infile.readlines()
        except:
            continue
    for i in range(len(lines)):
        lines[i] = lines[i].strip()
    verdict = lines[0]
    vector = str()
    for feature in features:
        if feature in lines[1:]:
            vector += '1'
        else:
            vector += '0'
    with open(output_file, 'a') as csv_file:
        csv_writer = csv.writer(csv_file)
        csv_writer.writerow([vector, verdict])
    print('Success:', filename)
