import json
import os
import sys

if len(sys.argv) != 4:
    print('Usage: python3 ' + sys.argv[0] + ' [reports directory] [0/1] [output directory]')
    exit()

input_dir = sys.argv[1]
if sys.argv[2] == '1':
    verdict = 1 # Malicious.
elif sys.argv[2] == '0':
    verdict = 0 # Benign.
else:
    print('Usage: python3 ' + sys.argv[0] + ' [directory] [0/1]')
    exit()
output_dir = sys.argv[3]

for filename in os.listdir(input_dir):

    with open(input_dir + '/' + filename, 'r') as cuckoo_report:
        try:
            data = json.load(cuckoo_report)
        except:
            print(filename + ' -> ERROR PARSING JSON')
            continue
    
    behavior = data.get('behavior')
    if behavior is None:
        print(filename + ' -> NO BEHAVIOR SECTION')
        continue

    processes = behavior.get('processes')
    if processes is None:
        print(filename + ' -> NO PROCESSES SECTION')
        continue

    output_file = output_dir + '/' + filename + '.txt'
    if os.path.exists(output_file):
        os.remove(output_file)

    with open(output_file, 'a') as outfile:
        outfile.write('%d\n' % verdict)

    for process in processes:
        for call in process.get('calls'):

            api_name = call.get('api')
            if api_name is None:
                print(filename + ' -> NO API NAME?')
                continue
            if api_name == '__exception__':
                print(filename + ' -> Skipping __exception__ call')
                continue

            return_value = call.get('return_value')
            if return_value is None:
                print(filename + ' -> NO RETURN VALUE')
                continue

            arguments = call.get('arguments')
            if arguments is None:
                print(filename + ' -> NO ARGUMENTS')
                continue

            if len(arguments) == 0:
                with open(output_file, 'a') as outfile:
                    outfile.write('%s...%s\n' % (api_name, return_value))
            else:
                for arg_index in range(len(arguments)):
                    arg_value = list(arguments.values())[arg_index] # Alphabeticalize keys to be consistent?
                    arg_value = str(arg_value)[:500] # Limit to 500 characters.
                    with open(output_file, 'a') as outfile:
                        try:
                            outfile.write('%s.%d.%s.%s\n' % (api_name, arg_index + 1, arg_value, return_value))
                        except:
                            print(filename + ' -> Skipping UTF-16 arguments')
    print(filename + ' -> Success')
